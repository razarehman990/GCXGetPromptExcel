<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convert Genesys Prompt To CSV</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #log {
            width: 80%;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            margin-top: 20px;
            padding: 10px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.5;
        }

        #loader {
            border: 16px solid #f3f3f3; /* Light grey */
            border-top: 16px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loader"></div>
    <div id="log"></div>

    <script>
        async function fetchPromptData(token, page = 1) {
            try {
                // Fetch prompt data for the specified page
                const response = await fetch(`https://api.cac1.pure.cloud/api/v2/architect/prompts?page=${page}&pageSize=500`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch prompt data: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();
                processData(data);
                
                // If there are more pages, fetch data for the next page recursively
                if (data.page < data.totalPages) {
                    await fetchPromptData(token, page + 1);
                }
            } catch (error) {
                console.error('Error fetching prompt data:', error);
                logError(`Error fetching prompt data: ${error}`);
            }
        }

        function processData(data) {
            const entities = data.entities || [];

            // Show loading spinner
            document.getElementById('loader').style.display = 'block';

            // Real-time logging
            const logDiv = document.getElementById('log');
            logDiv.innerHTML = ''; // Clear previous logs

            // Generate CSV content
            let csvContent = "data:text/csv;charset=utf-8,Name,Type,Language,Description,TtsString,MediaUri,FileName\n";

            // Promises array to store all file download promises
            const fileDownloadPromises = [];

            for (const entity of entities) {
                const name = entity.name || '';
                const description = entity.description || '';
                const resources = entity.resources || [];

                for (const resource of resources) {
                    const language = resource.language || '';
                    const ttsString = resource.ttsString || '';
                    const mediaUri = resource.mediaUri || '';

                    // Extract file extension from mediaUri
                    const fileExtension = mediaUri.split('.').pop();

                    // Construct filename using name and file extension
                    const fileName = `${name}.${fileExtension}`;

                    // Add row to CSV content
                    csvContent += `${name},user,${language},${description},${ttsString},${mediaUri},${fileName}\n`;

                    // Add download file promise to array
                    fileDownloadPromises.push(downloadFile(mediaUri, fileName, logDiv));
                    
                    // Delay between each download (1 second)
                    await delay(1000);
                }
            }

            // Wait for all file download promises to resolve
            Promise.all(fileDownloadPromises)
                .then(() => createCSV(csvContent))
                .catch(error => {
                    console.error('Error downloading files:', error);
                    logError(`Error downloading files: ${error}`);
                });
        }

        function downloadFile(url, fileName, logDiv) {
            return new Promise((resolve, reject) => {
                logDiv.innerHTML += `<span style="color: blue;">Downloading ${fileName}...</span><br>`;
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to download ${fileName}: ${response.status} - ${response.statusText}`);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        // Create object URL
                        const url = window.URL.createObjectURL(blob);

                        // Create anchor element
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = fileName;

                        // Click the anchor
                        a.click();

                        // Resolve the promise
                        resolve();
                    })
                    .catch(error => {
                        logDiv.innerHTML += `<span style="color: red;">Failed to download ${fileName}: ${error}</span><br>`;
                        console.error("Error downloading file:", error);
                        reject(error);
                    });
            });
        }

        function createCSV(csvContent) {
            // Create CSV file
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "GenesysPromptsWithURI.csv");
            document.body.appendChild(link);
            link.click();

            // Hide loading spinner
            document.getElementById('loader').style.display = 'none';
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function logError(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `<span style="color: red;">${message}</span><br>`;
        }

        // Retrieve access token from query string
        var token = new URLSearchParams(window.location.search).get('token');

        if (token) {
            // Fetch prompt data starting from page 1
            fetchPromptData(token);
        } else {
            console.error('Access token not found!');
            logError('Access token not found!');
        }
    </script>
</body>
</html>
